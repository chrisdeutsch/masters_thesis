% ~ 8-10 pages
\chapter{Decay Mode Classification of Hadronically Decaying $\tau$-Leptons}
\label{sec:decaymode}

In this chapter the sequence learning techniques developed for
tau-identification are applied to the problem of decay mode classification of
hadronic tau-lepton decays. In the following the decay modes containing one
charged hadron $h^\pm$ with one $h^\pm \pi^0$ or more than one neutral pion
$h^\pm \geq 2\pi^0$ as well as three charged hadrons without neutrals $3h^\pm$
or at least one neutral $3h^\pm \geq 1\pi^0$ shall be discriminated. These five
decay modes make up the majority of hadronic tau-lepton decays \todo{Continue
  (numbers). Kaons are rare}. Neural networks naturally extend from binary to
multi-class classification problems making them well-suited for the
discrimination of the hadronic decay modes.

At first a quick overview of the \emph{Tau Particle Flow}-Algorithm is given,
which is used to reconstruct neutral and charged decay products. Subsequently a
neural network is developed that uses the reconstructed decay products to
classify the decay mode into one of five categories. Finally the network is
extended by including additional information from conversion tracks, cluster
moments and shot information. In the following the notation established in
\cite{atlas:taurec:decaymodes} will be adopted.

\todo[inline]{Signature of the decay modes (Could be moved to
  \textit{Theoretical Background})}

\section{Tau Particle Flow}
\label{sec:tau_pflow}

The \emph{Tau Particle Flow}-Algorithm is a specialised particle flow algorithm
for reconstruction of charged and neutral constituents in hadronic tau-lepton
decays with visible transverse momenta of up to \SI{100}{\giga\electronvolt}. It
aims to improve reconstruction of individual particles by optimally combining
the information in several subdetector-systems. The reconstructed objects,
called charged or neutral \emph{particle flow objects} (PFO), can be used to
classify the decay mode of hadronic tau-lepton decays and can be used to improve
the energy resolution of the reconstructed hadronic tau decay by employing a
decay mode specific calibration. The following description of the algorithm is
based on \cite{atlas:taurec:decaymodes}.

Charged PFOs \todo{bring in charged pion} are reconstructed from tracks
classified as \emph{charged} according to the track classification by assigning
the charge and transverse momentum measured in the tracking system, which has
superior energy resolution for $p_\text{T} < \SI{100}{\giga\electronvolt}$ than
a calorimeter-based measurement. The energy of the PFO is calculated using a
$\pi^\pm$-mass hypothesis. \todo{Extensive hadronic showers. Hadronic part of
  the calo EM3 and HAD. Also deposit in EM calo.}

Neutral pions often deposit their energy in a single cluster in the EM
calorimeter (Presampler, EM1/EM2) caused by two collimated photons from the
$\pi^0$ decay. Therefore neutral PFOs are reconstructed by clustering the cells
in the electromagnetic part of the calorimeter \todo{in the core region? At
  EM-Scale?}. In cases where a cluster is close to a charged PFO the energy
contribution from the charged hadron in the EM calorimeter has to be separated
from the energy of the neutral pion. The energy $E_{h^\pm}^{\text{EM}}$ that
needs to be subtracted to remove the contribution of the charged hadron is
estimated by
\begin{align*}
  E_{h^\pm}^{\text{EM}} = E_{h^\pm}^{\text{track}} - E_{h^\pm}^{\text{HAD}} \eqcomma
\end{align*}
where $E_{h^\pm}^{\text{track}}$ is the energy of the charged PFO measured in
the tracking system and $E_{h^\pm}^{\text{HAD}}$ the energy of the charged PFO
deposited in the hadronic part of the calorimeter. $E_{h^\pm}^{\text{HAD}}$ is
calculated by matching clustered energy deposits in the HCAL to the closest
track of a charged PFO. The contribution of the charged hadron in the EM
calorimeter~$E_{h^\pm}^{\text{EM}}$ is subtracted from the closest neutral PFO
cluster if the angular distance between cluster and extrapolated track is
smaller than $\Delta R < 0.04$. \todo{Zero mass hypothesis for neutrals?}

Neutral PFOs can often be caused by incomplete subtraction of the charged hadron
energy deposition in the EM calorimeter or by pile-up. For decay mode
classification it is necessary to identify the neutral pions in all
reconstructed neutral PFOs of the tau decay. Boosted decision trees employing
shower shape and cluster moment information are used to identify neutral pions.

The number of identified neutral pions can already be used for a crude
\todo{Crude? Why is this so?} determination of the decay mode. The following
sections will be concerned with combining reconstructed PFOs in neural networks
to achieve better classification power.

\todo{Where to put this?} Due to the decrease in momentum resolution in the
tracker as well as the additional boost of the decay products of the tau leading
to merging of $\pi^0$-clusters, this method is optimized for operation in the
low-momentum regime $p_\text{T} < \SI{100}{\giga\electronvolt}$.

\section{General Idea}
\todo{Better name for this part}
\label{sec:pfo_general}

Idea is to combine properties of charged and neutral PFOs in recurrent neural
networks to perform multi-class classification. Mainly kinematic information is
used to describe the PFOs. Also the $\pi^0$-likeness in form of the neutral pion
identification BDT score is included in the classification to be able to
discriminate between neutral PFOs originating from $\pi^0$ and remnants of the
subtraction.

\todo[inline]{Preselection (same as ID); Low momentum taus:
  $\SI{20}{\giga\electronvolt} < p_\text{T} < \SI{100}{\giga\electronvolt}$;
  Track requirement 1- or 3-prong; Truth decay mode}

The network architecture used for the decay mode classification is shown in
figure \ref{fig:pfo_rnn_baseline_arch} and is similar to the networks used for
tau-identification in the previous chapter. At the input layer the network is
split into two branches each accepting a number of charged and neutral PFOs
respectively. The shared dense layer\footnote{Applies the same transformation on
  every element of the input sequence} applies an affine transformation on the
input variables of each PFO. Afterwards the input sequences are fed into the
recurrent LSTM layer which subsequently return a single vector of activations.
The activations of both branches are then merged and passed through a network
containing three dense layers. The final dense layer has five units (the number
of decay modes to classify) which are activated by the Softmax activation
function, ensuring that the output activations sum to one.

\begin{figure}[ht]
  \centering
  \includegraphics{./figures/decay_mode_classification/baseline_architecture.pdf}
  \caption{Architecture. Highlighted in blue are layers that operate on a sequence of inputs.}
  \label{fig:pfo_rnn_baseline_arch}
\end{figure}

\todo[inline]{Technically would allow multiple outputs: Could do Pi0 Cluster-ID
  internally. During the classification the prongness of the decay mode is not
  constrained -- add. migrations are possible}

\section{Baseline}
\label{sec:pfo_baseline}

For training and evaluation of the model a sample containing the process
$\gamma^* \rightarrow \tau \tau \, \text{(hadr.)}$ is used \todo{Reference
  samples in app.}. For training and evaluation of the model the baseline tau
selection given in chapter \ref{sec:bdt_eventsim} is applied. At reconstruction
and generator-level the visible transverse momentum~$p_\text{T}$ of the tau is
required to be less than \SI{100}{\giga\electronvolt}. Moreover only tau-leptons
with the true decay mode being one of $h^\pm$, $h^\pm \pi^0$,
$h^\pm \geq 2\pi^0$, $3h^\pm$ or $3h^\pm \geq 1\pi^0$ and omitting modes
containing charged kaons are considered.

The discrimination of the decay modes utilises kinematic quantities of the
reconstructed tau decay as well as the charged and neutral particle flow
objects:
\begin{description}
\item[Kinematic quantities of the tau decay:] The visible transverse momentum
  $p_\text{T}^\tau$ and the direction $(\varphi_\tau, \eta_\tau)$ of the
  reconstructed hadronic tau decay. The momentum is calibrated at LC-scale
  without applying the tau-specific energy calibration. \todo{Calib.\
    DetectorAxis}

\item[Kinematic quantities of charged and neutral PFOs:] The reconstructed
  transverse momentum $p_\text{T}^\text{PFO}$ and the signed angular distances
  to the reconstructed tau decay in transverse\footnote{The definition is
    analogous to the longitudinal case but also accounting for the periodicity
    in $\varphi$.}~$\Delta\varphi$ and longitudinal
  direction~$\Delta\eta := \eta_\text{PFO} - \eta_\tau$.
\end{description}
while also extending the variable set of the neutral PFOs with:
\begin{description}
\item[$\pi^0$ identification score $S_\text{BDT}^{\pi^0}$:] BDT-based
  discriminant combining cluster information in the electromagnetic part of the
  calorimeter to identify neutral PFOs originating from the $\pi^0$ decay.

\item[Number of shots $N_\text{shots}$:] Number of shots (cmp.\ section
  \todo{Ref.\ to reco}) associated with a neutral PFO cluster. Shots are
  associated with a cluster if it contains the seed cell of the shot and the
  cluster fulfils $E_\text{T} > \SI{500}{\mega\electronvolt}$ and is within
  $\Delta R < 0.4$ to the tau axis. In cases where the cell is shared between
  multiple clusters, it is associated to the cluster to which the seed cell
  contributes with the largest weight. \todo{Recover merged $\pi^0$ if more than
    2 shots.}
\end{description}
\todo[inline]{Give reasons for this variable selection.}

\todo[inline]{In contrast to the algorithm currently in use at the ATLAS
  experiment no discrimination of 1- and 3-prong modes according to the number
  of tracks that are classified as \emph{charged} is made. The reconstruction of
  charged PFOs is bound to charged tracks, such that each PFO is associated to a
  track. As all charged PFOs are passed to the network, the information on the
  number of charged tracks is available for processing. Therefore the network
  can access this information but it is not a strict requirement such that
  migrations 3-track taus to $h^\pm \geq 0 \pi^0$ are possible.}

\todo[inline]{Preprocessing:} The transverse momenta of the reconstructed tau as
well as the PFOs are log-transformed and subsequently standardised (by
subtracting the mean and dividing by the standard deviation of the transformed
variable). The remaining kinematic variables are transformed to fall into the
the $[-1, 1]$ range. For the neutral PFO specific variables
$S_\text{BDT}^{\pi^0}$ and $N_\text{shots}$ no preprocessing is needed.

Charged and neutral PFOs are passed in ascending transverse momentum ordering to
the shared dense layers with 24 units each. The intermediate representation of
the input sequence is then passed into the LSTM layers each with 24 units and
hard sigmoid recurrent activation. The recurrent layers return a single element
containing 24 scalar values which are subsequently merged and passed through
three dense layers with 48, 32 and 5 units respectively. The outputs of the
different layers are activated using the $\tanh$ activation function with the
exception of the last dense layer, which uses \emph{Softmax} activation.

For each reconstructed tau decay the model returns one probability for each of
the five decay modes. The reconstructed decay mode is then given as the mode
with the highest probability according to the model. A different scheme for
determining the decay mode would be to require the largest mode probability to
exceed the second largest by a predefined margin. This would increase the purity
of the reconstructed modes at the expense of reducing the reconstruction
efficiency (should be evaluated on analysis-level).

Reconstructed hadronic tau decays contain neutral PFOs that are not originating
from neutral pions but from other sources. Moreover it is not known how well
these PFOs are modelled in the simulation that is used to train and evaluate the
models. Therefore the neutral PFOs used in the RNN are required to pass a
$p_\text{T}$-threshold. Table \ref{tab:neut_ptcut} summarises the diagonal
efficiency of the classification for four different thresholds \todo{Requires
  retraining of the model!}.
\begin{table}[htb]
  \centering
  \input{./tables/neutral_pfo_ptcut.tex}
  \caption{Impact of a neutral $p_\text{T}$-cut on the diagonal
    efficiency.}
  \todo[inline]{Motivate \SI{1.5}{\giga\electronvolt} cut.}
  \label{tab:neut_ptcut}
\end{table}
It is observed that the overall classification performance does not degrade when
no $p_\text{T}$-cut is applied, indicating that the network is able to (since
$p_\text{T}^\text{PFO}$ is an input). Moreover the accuracy does not decrease
drastically \todo{better word?} when the threshold is increased such that a
threshold can be applied if it turns out that low momentum PFOs show significant
mismodelling. For further studies the \SI{1.5}{\giga\electronvolt} threshold is
used.


\begin{figure}[ht]
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/mig_mat_pantau.pdf}
    \subcaption{ATLAS default algorithm: \emph{PanTau}}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/mig_mat_baseline_ptcut_1_5.pdf}
    \subcaption{PFO-RNN with neutral $p_{\text{T}}$-cut of
      \SI{1.5}{\giga\electronvolt}}
  \end{subfigure}
  \caption{Migration matrices with normalised columns showing the migration of
    the true decay modes to the reconstructed modes. }
  \todo[inline]{After reconstruction in
    $\gamma^* \rightarrow \tau \tau \, \text{hadr.}$ and omitting decays
    containing neutral kaons.}
  \label{fig:migmat}
\end{figure}


\begin{figure}[ht]
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/comp_mat_pantau.pdf}
    \subcaption{ATLAS default algorithm: \emph{PanTau}}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/comp_mat_baseline_ptcut_1_5.pdf}
    \subcaption{PFO-RNN with neutral $p_{\text{T}}$-cut of
      \SI{1.5}{\giga\electronvolt}}
  \end{subfigure}
  \caption{Composition matrices with normalised rows showing the migration of
    the true decay modes to the reconstructed modes.}
  \label{fig:migmat}
\end{figure}


\begin{figure}[ht]
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/mode_proba_baseline_ptcut_1_5_only_1p/proba_1p0n.pdf}
    \subcaption{In most cases the probabilities for modes containing neutral
      pions to be classified as the $h^\pm$ mode are small. However in cases
      where no neutral PFO is reconstructed the probabilities can be large
      \SI{90}{\percent}.}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics{./figures/decay_mode_classification/mode_proba_baseline_ptcut_1_5_only_1p/proba_1p1n.pdf}
    \subcaption{The discrimination of modes with one neutral and more than one
      neutral pion is difficult. In cases of no reconstructed neutral pions the
      probabilities can be small ($\approx \SI{5}{\percent}$)}
  \end{subfigure}
  \caption{Mode probabilities for the $h^\pm$ and $h^\pm \pi^0$ modes. While
    each tau candidate is assigned a probability for all five decay modes the
    probabilities for the 3-prong modes have been omitted.}
  \label{fig:mode_proba_ptcut}
\end{figure}

Preprocessing:
\begin{itemize}
\item $p_\text{T}$: log-transform and standard scaling
\item $\eta$, $\phi$: Divided by maximum value ($2.5$ or $\pi$)
\item $\Delta \eta$, $\Delta \phi$: standard scaling
\item Cluster moments: Second\_R, secondEtaWRTClusterPosition, NPosECells\_EM1
  ... standard scaling
\item PI0BDT, NHitsinEM1, ENG\_FRAC\_CORE, energyfrac em2 - no scaling
\end{itemize}

\section{Additional Information}

\begin{description}
\item[Width $\langle R^2 \rangle$]
\item[$\eta$ width in EM1 $\langle (\eta - \eta_\text{cluster})^2\rangle$]
\item[Number of positive cells in EM1 $N_\text{EM1}^\text{pos}$]
\item[Core energy fraction $f_\text{core}$] Fraction of the total cluster energy
  contained in the highest energy cells in Presampler, EM1 and EM2.
\item[Energy fraction in EM2 $f_\text{EM2}$]
\end{description}
Longitudinal moments were not found to lead to an increase performance.


Neutral PFOs (Charged PFOs + whats listed here):
\begin{itemize}
\item $f_\text{core}$: \texttt{ENG\_FRAC\_CORE} Fraction of energy in the three
  hottest cells in each sampling \todo{Check}
\item $f_\text{EM2} = E_\text{EM2} / E$: Energy fraction in EM2 \todo{Why not
    EM1? -- Energy fraction is highly anti-correlated with EM1 therefore only
    one is chosen.}
\end{itemize}

\begin{table}[htb]
  \centering
  \input{./tables/pfo_add_info.tex}
  \caption{Additional experiments}
  \label{tab:pfo_add_experiments}
\end{table}

\begin{align*}
  f_\text{sub} = \frac{p_{\text{T}}^{\text{cluster}} - p_{\text{T}}^{\text{PFO}}}{p_{\text{T}}^{\text{PFO}}}
\end{align*}

\todo[inline]{Try out bidirectional LSTMs and stacked ones (still not
  overfitting).}

\todo[inline]{What else has been tested?}

\section{Combining Everything}

\todo[inline]{Class probabilities, Migration matrices (row + col.\ norm),
  Efficiency/Purity profiles. Improvements for Higgs CP measurement in
  $H \rightarrow \tau\tau \rightarrow \rho \rho 2\nu$. Performance when applying
  medium tau identification.}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "mythesis"
%%% End:
